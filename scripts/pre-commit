#!/usr/bin/env bash
#
# Wallfacer Pre-commit Hook
# =========================
# Rigorous quality checks before every commit.
# Install with: make install-hooks
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# Helper functions
info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[PASS]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

fail() {
    echo -e "${RED}[FAIL]${NC} $1"
    FAILED=1
}

divider() {
    echo -e "${BLUE}─────────────────────────────────────────────────${NC}"
}

# ============================================================================
# Pre-flight checks
# ============================================================================

echo ""
divider
echo -e "${BLUE}  WALLFACER PRE-COMMIT CHECKS${NC}"
divider
echo ""

# Check we're in a Rust project
if [[ ! -f "Cargo.toml" ]]; then
    fail "Not in a Rust project (no Cargo.toml found)"
    exit 1
fi

# ============================================================================
# Check 1: Formatting
# ============================================================================

info "Checking code formatting..."

if ! cargo fmt -- --check > /dev/null 2>&1; then
    fail "Code is not formatted. Run 'cargo fmt' to fix."
    echo ""
    echo "  Files that need formatting:"
    cargo fmt -- --check 2>&1 | grep "Diff in" | head -10 || true
    echo ""
else
    success "Code formatting OK"
fi

# ============================================================================
# Check 2: Clippy (Linting)
# ============================================================================

info "Running clippy linter..."

# Lints are configured in Cargo.toml [lints.clippy] section
CLIPPY_OUTPUT=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1) || {
    fail "Clippy found issues"
    echo ""
    echo "$CLIPPY_OUTPUT" | grep -E "^error|^warning" | head -20
    echo ""
}

if [[ $FAILED -eq 0 ]] || ! echo "$CLIPPY_OUTPUT" | grep -q "^error"; then
    # Only mark as success if we haven't already failed
    if [[ $FAILED -eq 0 ]]; then
        success "Clippy lints OK"
    fi
fi

# ============================================================================
# Check 3: Compilation
# ============================================================================

info "Checking compilation..."

if ! cargo check --all-targets > /dev/null 2>&1; then
    fail "Code does not compile"
    cargo check --all-targets 2>&1 | grep -E "^error" | head -10
else
    success "Compilation OK"
fi

# ============================================================================
# Check 4: Tests
# ============================================================================

info "Running tests..."

if ! cargo test --all-targets > /dev/null 2>&1; then
    fail "Tests failed"
    echo ""
    cargo test --all-targets 2>&1 | grep -E "^test .* FAILED|^error" | head -10
    echo ""
else
    success "All tests passed"
fi

# ============================================================================
# Check 5: Security (optional - only if cargo-audit is installed)
# ============================================================================

if command -v cargo-audit &> /dev/null; then
    info "Running security audit..."

    if ! cargo audit --quiet > /dev/null 2>&1; then
        warn "Security vulnerabilities found (run 'cargo audit' for details)"
        # Don't fail on audit - just warn
    else
        success "No known vulnerabilities"
    fi
else
    info "Skipping security audit (install with: cargo install cargo-audit)"
fi

# ============================================================================
# Check 6: No debug code
# ============================================================================

info "Checking for debug code..."

# Look for common debug patterns that shouldn't be committed
DEBUG_PATTERNS=(
    "dbg!"
    "println!.*DEBUG"
    "println!.*TODO"
    "#\[allow(dead_code)\]"  # Allow in tests, but flag in main code
)

DEBUG_FOUND=0
for pattern in "${DEBUG_PATTERNS[@]}"; do
    if grep -rn "$pattern" src/ --include="*.rs" 2>/dev/null | grep -v "test" | grep -v "#\[cfg(test)\]" | head -3; then
        DEBUG_FOUND=1
    fi
done

if [[ $DEBUG_FOUND -eq 1 ]]; then
    warn "Debug code found (review before committing)"
else
    success "No debug code found"
fi

# ============================================================================
# Check 7: No large files
# ============================================================================

info "Checking for large files..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

LARGE_FILES=0
for file in $STAGED_FILES; do
    if [[ -f "$file" ]]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        # 500KB limit
        if [[ $SIZE -gt 512000 ]]; then
            warn "Large file: $file ($(($SIZE / 1024))KB)"
            LARGE_FILES=1
        fi
    fi
done

if [[ $LARGE_FILES -eq 0 ]]; then
    success "No large files"
fi

# ============================================================================
# Check 8: No secrets
# ============================================================================

info "Checking for potential secrets..."

SECRET_PATTERNS=(
    "password\s*=\s*[\"']"
    "api_key\s*=\s*[\"']"
    "secret\s*=\s*[\"']"
    "token\s*=\s*[\"'][a-zA-Z0-9]"
    "BEGIN RSA PRIVATE KEY"
    "BEGIN OPENSSH PRIVATE KEY"
)

SECRETS_FOUND=0
for pattern in "${SECRET_PATTERNS[@]}"; do
    if grep -rniE "$pattern" src/ --include="*.rs" 2>/dev/null | head -3; then
        SECRETS_FOUND=1
    fi
done

if [[ $SECRETS_FOUND -eq 1 ]]; then
    fail "Potential secrets found - review before committing!"
else
    success "No secrets detected"
fi

# ============================================================================
# Summary
# ============================================================================

echo ""
divider

if [[ $FAILED -eq 1 ]]; then
    echo -e "${RED}  ✗ PRE-COMMIT CHECKS FAILED${NC}"
    echo ""
    echo "  Fix the issues above and try again."
    echo "  To bypass (not recommended): git commit --no-verify"
    divider
    echo ""
    exit 1
else
    echo -e "${GREEN}  ✓ ALL PRE-COMMIT CHECKS PASSED${NC}"
    divider
    echo ""
    exit 0
fi
